#!/usr/bin/env bash

# Detect CPU
while read VendorID; do
	[[ "$VendorID" == *vendor_id* ]] && break
done < /proc/cpuinfo
case "$VendorID" in
	*AMD*)
		CPU=amd ;;
	*Intel*)
		CPU=intel ;;
esac
unset -v VendorID

Disk=$(findmnt -o SOURCE --noheadings /boot)

if [[ $Disk == *nvme* ]]; then
	Modules='nvme nvme_core'
	Disk="${Disk/p*/}"
	P=p
else
	Modules='ahci sd_mod'
	Disk="${Disk/[1-9]*/}"
fi

# Find rootfs UUID
System=$(lsblk -o UUID --noheadings "$Disk$P"2 | tail -n 1)
Mapper=$(findmnt -o UUID --noheadings /)

# Options for LUKS
Kernel="rd.luks.name=$System=luks2 rd.luks.options=discard"

# Specify the rootfs
Kernel+=" root=UUID=$Mapper"

# Specify the initrd files
Kernel+=" ro initrd=\\$CPU-ucode.img initrd=\\initramfs-linux-hardened.img"

# Speed improvement
Kernel+=' quiet libahci.ignore_sss=1 zswap.enabled=0'

# Enable apparmor
Kernel+=' lsm=landlock,lockdown,yama,apparmor,bpf'

# Install bootloader to UEFI
efibootmgr --disk "$Disk" --part 1 --create \
	--label 'Arch Linux' \
	--loader '\vmlinuz-linux-hardened' \
	--unicode "$Kernel"
