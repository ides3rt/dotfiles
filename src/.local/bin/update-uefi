#!/usr/bin/env bash

# Detect CPU
while read VendorID; do
	[[ "$VendorID" == *vendor_id* ]] && break
done < /proc/cpuinfo
case "$VendorID" in
	*AMD*)
		CPU=amd ;;
	*Intel*)
		CPU=intel ;;
esac
unset -v VendorID

Disk=$(findmnt / -o SOURCE --noheadings)

if [[ $Disk == *nvme* ]]; then
	Disk="${Disk/p*/}"
else
	Disk="${Disk/[1-9]*/}"
fi

# Find rootfs UUID
System=$(findmnt / -o UUID --noheadings)

# Required Kernel Parameter
Kernel="root=UUID=$System ro initrd=\\$CPU-ucode.img"
Kernel+=' initrd=\initramfs-linux-hardened.img'

# Speed improvement
Kernel+=' quiet libahci.ignore_sss=1 zswap.enabled=0'

# Enable apparmor
Kernel+=' lsm=landlock,lockdown,yama,apparmor,bpf'

# Install bootloader to UEFI
efibootmgr --disk "$Disk" --part 1 --create \
	--label 'Arch Linux' \
	--loader '\vmlinuz-linux-hardened' \
	--unicode "$Kernel"
